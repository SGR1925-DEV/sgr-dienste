<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Ruwertal - Dienste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. Supabase Client laden -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- App Logic -->
    <script>
        // --- KONFIGURATION ---
        // Bitte hier deine Werte aus Supabase einfügen!
        const SUPABASE_URL = 'https://iydrigoheenchbxvhtdm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZHJpZ29oZWVuY2hieHZodGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjQxMDQsImV4cCI6MjA4MDI0MDEwNH0.zX3DHzhytyGaS0vEL7zmz9oXJitOfdBWYCgXUWsekdo';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function appData() {
            return {
                currentView: 'dashboard',
                isAdmin: false,
                activeMatch: null,
                showModal: false,
                showToast: false,
                toastMessage: '',
                selectedSlot: null,
                inputName: '',
                loading: true, // Lade-Indikator
                
                newMatch: { opponent: '', date: '', time: '' },

                matches: [],
                slots: [],

                // --- INIT (Start) ---
                async init() {
                    console.log("App startet...");
                    await this.fetchData();
                    
                    // Echtzeit-Updates abonnieren (Magie!)
                    supabase.channel('public:slots')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'slots' }, payload => {
                            console.log('Änderung erkannt!', payload);
                            this.fetchData(); // Daten neu laden, wenn jemand anders was ändert
                        })
                        .subscribe();
                },

                async fetchData() {
                    // 1. Spiele laden
                    let { data: matchesData, error: matchesError } = await supabase
                        .from('matches')
                        .select('*')
                        .order('id', { ascending: true });
                    
                    if(matchesData) this.matches = matchesData;

                    // 2. Slots laden
                    let { data: slotsData, error: slotsError } = await supabase
                        .from('slots')
                        .select('*');

                    if(slotsData) this.slots = slotsData;
                    
                    this.loading = false;
                },

                // --- HELPER FUNCTIONS ---
                getSlotsForMatchAndCategory(matchId, category) {
                    if(!matchId) return [];
                    return this.slots.filter(s => s.match_id === matchId && s.category === category);
                },
                getOpenSlotCount(matchId) {
                    return this.slots.filter(s => s.match_id === matchId && s.user_name === null).length;
                },
                getFilledSlotCount(matchId) {
                    return this.slots.filter(s => s.match_id === matchId && s.user_name !== null).length;
                },
                getProgress(matchId) {
                    const mId = matchId || (this.activeMatch ? this.activeMatch.id : 0);
                    const total = this.slots.filter(s => s.match_id === mId).length;
                    if (total === 0) return 0;
                    const filled = this.getFilledSlotCount(mId);
                    return (filled / total) * 100;
                },

                // --- NAVIGATION ---
                selectMatch(match) {
                    this.activeMatch = match;
                    this.currentView = 'detail';
                    window.scrollTo(0,0);
                },
                goToAdmin() {
                    this.currentView = this.isAdmin ? 'adminDashboard' : 'adminLogin';
                },

                // --- USER ACTIONS (Eintragen) ---
                openModal(slot) {
                    this.selectedSlot = slot;
                    this.inputName = '';
                    this.showModal = true;
                    setTimeout(() => {
                        const input = document.querySelector('input[type="text"]');
                        if(input) input.focus();
                    }, 100);
                },

                async confirmSlot() {
                    if(!this.selectedSlot || this.inputName.length < 2) return;

                    // Update in Supabase
                    const { error } = await supabase
                        .from('slots')
                        .update({ user_name: this.inputName })
                        .eq('id', this.selectedSlot.id);

                    if (!error) {
                        this.triggerToast("Klasse! Du bist eingetragen.");
                        this.showModal = false;
                        this.fetchData(); // UI aktualisieren
                    } else {
                        alert("Fehler beim Speichern!");
                    }
                },

                async removeUser(slotId) {
                    if(this.isAdmin || confirm("Möchtest du dich wirklich austragen?")) {
                        const { error } = await supabase
                            .from('slots')
                            .update({ user_name: null })
                            .eq('id', slotId);
                        
                        if(!error) {
                            this.triggerToast(this.isAdmin ? "Nutzer entfernt." : "Du wurdest ausgetragen.");
                            this.fetchData();
                        }
                    }
                },

                // --- ADMIN ACTIONS ---
                loginAdmin() {
                    // Demo Passwort Check
                    // In echt würde man hier Supabase Auth nehmen
                    if(true) { 
                        this.isAdmin = true;
                        this.currentView = 'adminDashboard';
                        this.triggerToast("Admin-Modus aktiviert");
                    }
                },
                logoutAdmin() {
                    this.isAdmin = false;
                    this.currentView = 'dashboard';
                    this.triggerToast("Ausgeloggt");
                },
                
                async deleteMatch(id) {
                    if(confirm("Spiel wirklich löschen?")) {
                        await supabase.from('matches').delete().eq('id', id);
                        this.fetchData();
                    }
                },
                
                async addMatch() {
                    if(!this.newMatch.opponent || !this.newMatch.date) return;
                    
                    // 1. Match anlegen
                    const { data: matchData, error } = await supabase
                        .from('matches')
                        .insert([{ 
                            opponent: this.newMatch.opponent, 
                            date: this.newMatch.date, 
                            time: this.newMatch.time || '14:30' 
                        }])
                        .select();

                    if(error) return alert("Fehler beim Anlegen");

                    const newMatchId = matchData[0].id;

                    // 2. Standard-Slots anlegen
                    const standardSlots = [
                        { category: 'Theke (Vereinsheim)', time: '13:30 - 16:00' },
                        { category: 'Theke (Vereinsheim)', time: '16:00 - Ende' },
                        { category: 'Grillhütte', time: '13:30 - Ende' },
                        { category: 'Ordner', time: '14:00 - 16:30' },
                        { category: 'Kassierer', time: '14:00 - 14:30' }
                    ];

                    const slotsToInsert = standardSlots.map(s => ({
                        match_id: newMatchId,
                        category: s.category,
                        time: s.time,
                        user_name: null
                    }));

                    await supabase.from('slots').insert(slotsToInsert);

                    this.newMatch = { opponent: '', date: '', time: '' }; 
                    this.triggerToast("Spiel angelegt!");
                    this.fetchData();
                },

                triggerToast(msg) {
                    this.toastMessage = msg;
                    this.showToast = true;
                    setTimeout(() => this.showToast = false, 3000);
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div x-data="appData()" x-init="init()" class="max-w-md mx-auto bg-slate-50 min-h-screen shadow-2xl relative overflow-hidden border-x border-slate-200 flex flex-col">
        
        <!-- HEADER -->
        <div class="text-white p-4 flex items-center justify-between sticky top-0 z-30 shadow-md transition-colors duration-300"
             :class="isAdmin ? 'bg-slate-800' : 'bg-blue-700'">
            <div class="flex items-center gap-3">
                <button x-show="currentView === 'detail'" @click="currentView = isAdmin ? 'adminDashboard' : 'dashboard'" class="mr-1 hover:bg-white/20 p-1 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button x-show="currentView === 'adminLogin' || (currentView === 'adminDashboard' && !isAdmin)" @click="currentView = 'dashboard'" class="mr-1 hover:bg-white/20 p-1 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>

                <div>
                    <h1 class="font-bold text-lg leading-tight" x-text="isAdmin ? 'SGR Admin-Bereich' : 'SG Ruwertal 1925 e.V.'"></h1>
                    <p class="text-xs text-blue-200 opacity-90" x-text="isAdmin ? 'Verwaltung' : 'Dienstplan App • Kasel'"></p>
                </div>
            </div>
            
            <button x-show="isAdmin" @click="logoutAdmin()" class="text-xs bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded font-bold transition-colors">Logout</button>
            <div x-show="!isAdmin" class="w-9 h-9 bg-blue-800 rounded-full flex items-center justify-center text-xs border border-blue-500 font-bold shadow-sm">SGR</div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-grow relative">

            <!-- Loading Spinner -->
            <div x-show="loading" class="absolute inset-0 z-40 bg-slate-50 flex items-center justify-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            </div>

            <!-- DASHBOARD -->
            <div x-show="currentView === 'dashboard' && !loading" class="p-4 space-y-4 pb-20">
                <div class="flex justify-between items-end mb-2 px-1">
                    <h2 class="text-slate-700 font-bold text-lg">Heimspiele (Rasenplatz)</h2>
                    <span class="text-xs text-slate-400 mb-1">Saison 24/25</span>
                </div>
                
                <template x-for="match in matches" :key="match.id">
                    <div @click="selectMatch(match)" class="group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative active:scale-[0.98] transition-all cursor-pointer hover:shadow-md hover:border-blue-300">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 transition-colors duration-500" 
                             :class="{ 'bg-red-600': getOpenSlotCount(match.id) > 2, 'bg-amber-400': getOpenSlotCount(match.id) <= 2 && getOpenSlotCount(match.id) > 0, 'bg-blue-600': getOpenSlotCount(match.id) === 0 }"></div>
                        <div class="p-4 pl-5">
                            <div class="flex justify-between items-start">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider" x-text="match.date + ' • ' + match.time + ' Uhr'"></div>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border shadow-sm"
                                      :class="{ 'bg-red-50 text-red-700 border-red-100': getOpenSlotCount(match.id) > 2, 'bg-amber-50 text-amber-700 border-amber-100': getOpenSlotCount(match.id) <= 2 && getOpenSlotCount(match.id) > 0, 'bg-blue-50 text-blue-700 border-blue-100': getOpenSlotCount(match.id) === 0 }">
                                    <span x-text="getOpenSlotCount(match.id) === 0 ? 'Voll besetzt' : 'Gesucht: ' + getOpenSlotCount(match.id)"></span>
                                </span>
                            </div>
                            <div class="text-xl font-bold text-slate-800 mt-1 truncate">
                                <span class="text-slate-400 font-normal text-sm align-middle mr-1">vs.</span> <span x-text="match.opponent"></span>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div x-show="matches.length === 0" class="text-center text-slate-400 py-10">Keine Spiele eingetragen.</div>
            </div>

            <!-- DETAIL VIEW -->
            <div x-show="currentView === 'detail'" x-cloak class="pb-24">
                <div class="bg-white border-b border-slate-200 p-4 shadow-sm z-20 sticky top-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wide" x-text="activeMatch?.date + ' • ' + activeMatch?.time"></div>
                            <h2 class="text-xl font-bold text-slate-800 leading-tight mt-1">vs. <span x-text="activeMatch?.opponent"></span></h2>
                        </div>
                        <div x-show="isAdmin" class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-xs font-bold uppercase border border-slate-200">Admin Mode</div>
                    </div>
                    <div class="mt-4 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-1000 ease-out shadow-sm" :class="getProgress() === 100 ? 'bg-blue-600' : 'bg-amber-400'" :style="'width: ' + getProgress() + '%'"></div>
                    </div>
                </div>

                <div class="p-4 space-y-8">
                    <!-- Wir nehmen hier feste Kategorien an, könnten aber auch dynamisch sein -->
                    <template x-for="category in ['Theke (Vereinsheim)', 'Grillhütte', 'Ordner', 'Kassierer']">
                        <div x-show="getSlotsForMatchAndCategory(activeMatch?.id, category).length > 0">
                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 ml-1" x-text="category"></h3>
                            <div class="space-y-3 pl-1">
                                <template x-for="slot in getSlotsForMatchAndCategory(activeMatch?.id, category)" :key="slot.id">
                                    <div class="relative group">
                                        <div class="flex items-center justify-between p-3.5 rounded-xl border transition-all duration-200"
                                             :class="slot.user_name ? 'bg-slate-50 border-slate-100' : 'bg-white border-blue-100 shadow-sm'">
                                            
                                            <div class="flex-1">
                                                <div class="text-sm font-bold text-slate-800" x-text="slot.time + ' Uhr'"></div>
                                                <div class="text-sm mt-1">
                                                    <template x-if="slot.user_name">
                                                        <span class="text-slate-600 font-medium flex items-center gap-1.5">
                                                            <div class="w-5 h-5 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-[10px] font-bold">✓</div>
                                                            <span x-text="slot.user_name"></span>
                                                        </span>
                                                    </template>
                                                    <template x-if="!slot.user_name">
                                                        <span class="text-slate-400 text-xs font-medium">Noch offen</span>
                                                    </template>
                                                </div>
                                            </div>

                                            <template x-if="!slot.user_name">
                                                <button @click="openModal(slot)" class="bg-blue-50 text-blue-700 border border-blue-200 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 hover:text-white transition-all shadow-sm">
                                                    <span x-text="isAdmin ? '+ Zuweisen' : 'Eintragen'"></span>
                                                </button>
                                            </template>
                                            <template x-if="slot.user_name">
                                                <button @click="removeUser(slot.id)" class="text-slate-300 hover:text-red-500 transition-colors px-2">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- ADMIN LOGIN & DASHBOARD -->
            <div x-show="currentView === 'adminLogin'" class="p-8 flex flex-col items-center justify-center h-full pt-20">
                <h2 class="text-xl font-bold text-slate-800 mb-2">Admin Login</h2>
                <button @click="loginAdmin()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition-colors">Einloggen (Demo)</button>
            </div>

            <div x-show="currentView === 'adminDashboard'" class="p-4 space-y-6 pb-24">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4">Neues Heimspiel</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input x-model="newMatch.date" type="text" placeholder="Datum" class="p-2 border rounded bg-slate-50 text-sm">
                        <input x-model="newMatch.time" type="text" placeholder="Zeit" class="p-2 border rounded bg-slate-50 text-sm">
                    </div>
                    <input x-model="newMatch.opponent" type="text" placeholder="Gegner" class="w-full p-2 border rounded bg-slate-50 text-sm mb-3">
                    <button @click="addMatch()" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 text-sm">Spiel erstellen</button>
                </div>

                <div>
                    <h3 class="font-bold text-slate-800 mb-3 ml-1">Spiele verwalten</h3>
                    <div class="space-y-3">
                        <template x-for="match in matches" :key="match.id">
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-slate-800">vs. <span x-text="match.opponent"></span></div>
                                    <div class="text-xs text-slate-400" x-text="match.date"></div>
                                </div>
                                <button @click="deleteMatch(match.id)" class="text-red-500 hover:bg-red-50 p-2 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="p-4 text-center text-xs text-slate-400 bg-slate-50 border-t border-slate-200">
            <span x-show="!isAdmin" @click="goToAdmin()" class="cursor-pointer hover:text-slate-600">Admin Login</span>
            <span x-show="isAdmin" class="text-green-600 font-bold">Admin Modus aktiv</span>
        </div>

        <!-- MODAL & TOAST (GLEICH WIE VORHER, NUR ANGEPASST FÜR FUNKTIONEN) -->
        <div x-show="showModal" x-cloak class="absolute inset-0 z-50 flex items-end justify-center sm:items-center bg-slate-900/60 backdrop-blur-[2px]" x-transition.opacity>
            <div class="bg-white w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl transform transition-all" @click.away="showModal = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-y-full sm:translate-y-10" x-transition:enter-end="translate-y-0">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">Name</label>
                    <input x-model="inputName" @keydown.enter="inputName.length >= 2 ? confirmSlot() : null" type="text" placeholder="Vorname Nachname" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all text-slate-800 font-medium shadow-sm">
                </div>
                <div class="flex gap-3">
                    <button @click="showModal = false" class="flex-1 py-3.5 text-slate-600 font-bold bg-white border border-slate-200 rounded-xl">Abbrechen</button>
                    <button @click="confirmSlot()" :disabled="inputName.length < 2" class="flex-1 py-3.5 bg-blue-600 text-white font-bold rounded-xl">Speichern</button>
                </div>
            </div>
        </div>

        <div x-show="showToast" x-cloak class="absolute top-4 left-4 right-4 z-50 flex justify-center pointer-events-none" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="-translate-y-10 opacity-0" x-transition:enter-end="translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
            <div class="bg-slate-800/95 backdrop-blur text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-slate-700">
                <div class="text-sm font-bold tracking-wide"><span x-text="toastMessage"></span></div>
            </div>
        </div>

    </div>
</body>
</html>
